{% extends "base.html" %}

{% block title %}Session {{ session.session_id[:8] }} - Claude Session Manager{% endblock %}

{% block content %}
<div>
    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
        <div class="flex items-center space-x-4">
            <a href="/sessions" class="text-gray-400 hover:text-white">&larr; Back</a>
            <h1 class="text-2xl font-bold flex items-center">
                {% if session.is_active %}
                <span class="w-3 h-3 bg-green-500 rounded-full mr-3 animate-pulse"></span>
                {% endif %}
                Session <code class="text-purple-400 ml-2">{{ session.session_id[:8] }}...</code>
            </h1>
        </div>
        <a href="/sessions/{{ session.session_id }}/context"
           class="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded">
            Export Context
        </a>
    </div>

    <!-- Metadata -->
    <div class="bg-gray-800 rounded-lg p-6 border border-gray-700 mb-6">
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div>
                <div class="text-gray-500 text-sm">Project</div>
                <div class="text-gray-300 font-mono text-sm">{{ session.project_path }}</div>
            </div>
            <div>
                <div class="text-gray-500 text-sm">Started</div>
                <div class="text-gray-300">{{ session.start_time.strftime('%Y-%m-%d %H:%M') }}</div>
            </div>
            <div>
                <div class="text-gray-500 text-sm">Last Activity</div>
                <div class="text-gray-300">{{ session.last_activity|format_timestamp }}</div>
            </div>
            <div>
                <div class="text-gray-500 text-sm">Model</div>
                <div class="text-gray-300">{{ session.model_used or 'Unknown' }}</div>
            </div>
            <div>
                <div class="text-gray-500 text-sm">Messages</div>
                <div class="text-gray-300">{{ session.message_count }} ({{ session.user_message_count }} user / {{ session.assistant_message_count }} assistant)</div>
            </div>
            <div>
                <div class="text-gray-500 text-sm">Tokens</div>
                <div class="text-gray-300">
                    {{ ((session.total_input_tokens + session.total_output_tokens) / 1000)|round|int }}K total
                </div>
            </div>
            <div>
                <div class="text-gray-500 text-sm">Status</div>
                <div class="{% if session.is_active %}text-green-400{% else %}text-gray-400{% endif %}">
                    {% if session.is_active %}Active{% else %}Completed{% endif %}
                </div>
            </div>
            <div>
                <div class="text-gray-500 text-sm">Full ID</div>
                <div class="text-gray-300 font-mono text-xs break-all">{{ session.session_id }}</div>
            </div>
        </div>
    </div>

    <!-- Tabs -->
    <div class="border-b border-gray-700 mb-6">
        <nav class="flex space-x-8">
            <button class="border-b-2 border-purple-500 text-purple-400 px-1 py-4 text-sm font-medium">
                Conversation
            </button>
            {% if todos %}
            <button class="border-b-2 border-transparent text-gray-400 hover:text-gray-300 px-1 py-4 text-sm font-medium">
                Todos ({{ todos|length }})
            </button>
            {% endif %}
        </nav>
    </div>

    <!-- Conversation -->
    <div class="space-y-4">
        {% for message in messages %}
        <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
            <div class="flex items-start space-x-3">
                <div class="flex-shrink-0">
                    {% if message.type == 'user' %}
                    <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center text-sm">U</div>
                    {% else %}
                    <div class="w-8 h-8 bg-purple-600 rounded-full flex items-center justify-center text-sm">C</div>
                    {% endif %}
                </div>
                <div class="flex-1 min-w-0">
                    <div class="flex items-center space-x-2 mb-2">
                        <span class="font-medium {% if message.type == 'user' %}text-blue-400{% else %}text-purple-400{% endif %}">
                            {% if message.type == 'user' %}You{% else %}Claude{% endif %}
                        </span>
                        <span class="text-gray-500 text-xs">{{ message.timestamp.strftime('%H:%M') }}</span>
                        {% if message.model %}
                        <span class="text-gray-600 text-xs">{{ message.model }}</span>
                        {% endif %}
                    </div>
                    <div class="text-gray-300 message-content">{{ message.content[:2000] }}{% if message.content|length > 2000 %}...{% endif %}</div>

                    {% if message.tool_calls %}
                    <div class="mt-3 space-y-1">
                        {% for tool in message.tool_calls %}
                        <div class="text-gray-500 text-sm flex items-center">
                            <span class="text-yellow-500 mr-2">&#9881;</span>
                            Tool: {{ tool.name }}
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}

                    {% if message.thinking %}
                    <details class="mt-3">
                        <summary class="text-gray-500 text-sm cursor-pointer hover:text-gray-400">
                            View thinking...
                        </summary>
                        <div class="mt-2 p-3 bg-gray-900 rounded text-gray-400 text-sm message-content">
                            {{ message.thinking[:1000] }}{% if message.thinking|length > 1000 %}...{% endif %}
                        </div>
                    </details>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}

        {% if messages|length >= 100 %}
        <div class="text-center py-4">
            <span class="text-gray-500">Showing first 100 messages</span>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}
